(()=>{"use strict";const t=/Android|iPhone|iPad|iPod|SymbianOS|Windows Phone/.test(navigator.userAgent),e=t?["touchstart","touchmove","touchend"]:["mousedown","mousemove","mouseup"],n=t=>{let e,n,{canvas:i,event:s}=t,r=i.getBoundingClientRect(),o=i.width,a=i.height,l=s.x-r.x,h=s.y-r.y;return e=o*(l/r.width),n=a*(h/r.height),{x:e,y:n}},i=t=>{let{ctx:e,start:n,end:i,strokeWidth:s=1,strokeColor:r="#000000",antiAliasing:o=!1}=t;e.save();for(let t=0;t<1;t++)e.beginPath(),e.lineCap="round",e.lineWidth=s,"transparent"===r?(e.strokeStyle="#ffffff",e.globalCompositeOperation="destination-out"):e.strokeStyle=r,e.moveTo(n.x,n.y),e.lineTo(i.x,i.y),e.stroke();e.restore()},s=(()=>{let s=null,r=null;return{Start:function(){s=this.canvas,r=this.ctx;const o=t=>{t.preventDefault()};let a=null;const l=e=>{let{strokeWidth:o,strokeColor:l}=this.strokeConfig,h=t?e.touches[0].pageX:e.x,c=t?e.touches[0].pageY:e.y,u=n({canvas:s,event:{x:h,y:c}});this.Operating(),i({start:a,end:u,ctx:r,strokeWidth:o,strokeColor:l}),a=u,e.preventDefault()},h=()=>{this.OperatingEnd(),document.removeEventListener(e[1],l),document.removeEventListener("selectstart",o),document.removeEventListener(e[2],h)};s["on"+e[0]]=c=>{let{strokeWidth:u,strokeColor:d}=this.strokeConfig,g=t?c.touches[0].pageX:c.x,v=t?c.touches[0].pageY:c.y;a=n({canvas:s,event:{x:g,y:v}}),this.OperatingStart(),i({start:a,end:a,ctx:r,strokeWidth:u,strokeColor:d}),document.addEventListener(e[1],l,{passive:!1}),document.addEventListener("selectstart",o),document.addEventListener(e[2],h)}},Quit:function(){s["on"+e[0]]=null}}})(),r=t=>{let{type:e,ctx:n,fillStyle:i,param:s}=t;if(n.save(),n.beginPath(),"transparent"===i?(n.fillStyle="#fff",n.globalCompositeOperation="destination-out"):n.fillStyle=i,"circle"===e)((t,e)=>{let{x:n,y:i,radiusX:s,radiusY:r,rotation:o=2*Math.PI,startAngle:a=0,endAngle:l=2*Math.PI,counterclockwise:h=1}=e;t.ellipse(n,i,s,r,o,a,l,h)})(n,s);else if("rect"===e){let{x:t,y:e,w:i,h:r}=s;n.fillRect(t,e,i,r)}n.fill(),n.restore()},o=t=>{let e=document.createElement("canvas"),n=e.getContext("2d");return e.width=t.width,e.height=t.height,n.drawImage(t,0,0),e},a=(t,e,n)=>{let i=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),s={};return s.x=e.x+(e.x-t.x)/i*n,s.y=e.y+(e.y-t.y)/i*n,s},l=(()=>{let s=null,l=null,h=[],c=null,u=null,d=!0;const g=e=>{if(h.length>0){let i=t?e.touches[0].pageX:e.x,r=t?e.touches[0].pageY:e.y,o=n({canvas:s,event:{x:i,y:r}}),a=h[h.length-1];a.x=o.x,a.y=o.y,v()}e.preventDefault()},v=()=>{let{strokeWidth:t,strokeColor:e}=c.strokeConfig,{width:n,height:o}=c.canvas,d=h[0],g=h[1];if(l.clearRect(0,0,n,o),l.drawImage(u,0,0),d)if(g){let n=a(d,g,s.width),r=a(g,d,s.width);i({ctx:l,start:n,end:r,strokeWidth:t,strokeColor:e})}else r({ctx:l,type:"circle",fillStyle:"#000000",param:{x:d.x,y:d.y,radiusX:1,radiusY:1}})},p=()=>{h.length=0,v()},y=()=>{u=o(c.canvas)};return{name:"rline",Start:function(){u=o(this.canvas),h=[],c=this,s=this.canvas,l=this.ctx;const i=t=>{t.preventDefault()},r=()=>{2===h.length&&(d=!0,h.length=0,this.OperatingEnd(),y()),document.removeEventListener("selectstart",i),document.removeEventListener(e[2],r),document.removeEventListener(e[1],g)};s["on"+e[0]]=o=>{if(!t&&1!==o.buttons)return;let a=t?o.touches[0].pageX:o.x,l=t?o.touches[0].pageY:o.y,c=n({canvas:s,event:{x:a,y:l}});d&&(this.OperatingStart(),d=!1),h.push(c),v(),document.addEventListener(e[1],g,{passive:!1}),document.addEventListener("selectstart",i),document.addEventListener(e[2],r)},s.oncontextmenu=t=>{t.preventDefault(),p(),this.OperatingEnd(),u=o(s)}},Quit:function(){p(),s.oncontextmenu=null,s["on"+e[0]]=null,t||document.removeEventListener(e[1],g)},UpdateClone:y}})(),h=(()=>{let s=null,a=null,l=[],h=null,c=null,u=!0;const d=e=>{if(l.length>0){let i=t?e.touches[0].pageX:e.x,r=t?e.touches[0].pageY:e.y,o=n({canvas:s,event:{x:i,y:r}}),a=l[l.length-1];a.x=o.x,a.y=o.y,g()}e.preventDefault()},g=()=>{let{strokeWidth:t,strokeColor:e}=h.strokeConfig,{width:n,height:o}=h.canvas,u=l[0],d=l[1];if(a.clearRect(0,0,n,o),a.drawImage(c,0,0),u)if(d){let n=((t,e,n)=>{let i=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),s={};return s.x=e.x+(e.x-t.x)/i*n,s.y=e.y+(e.y-t.y)/i*n,s})(u,d,s.width);i({ctx:a,start:u,end:n,strokeWidth:t,strokeColor:e})}else r({ctx:a,type:"circle",fillStyle:"#000000",param:{x:u.x,y:u.y,radiusX:1,radiusY:1}})},v=()=>{l.length=0,g()},p=()=>{c=o(h.canvas)};return{name:"rline",Start:function(){c=o(this.canvas),l=[],h=this,s=this.canvas,a=this.ctx;const i=t=>{t.preventDefault()},r=()=>{2===l.length&&(u=!0,l.length=0,this.OperatingEnd(),p()),document.removeEventListener("selectstart",i),document.removeEventListener(e[2],r),document.removeEventListener(e[1],d)};s["on"+e[0]]=o=>{if(!t&&1!==o.buttons)return;let a=t?o.touches[0].pageX:o.x,h=t?o.touches[0].pageY:o.y,c=n({canvas:s,event:{x:a,y:h}});u&&(this.OperatingStart(),u=!1),l.push(c),g(),document.addEventListener(e[1],d,{passive:!1}),document.addEventListener("selectstart",i),document.addEventListener(e[2],r)},s.oncontextmenu=t=>{t.preventDefault(),v(),this.OperatingEnd(),c=o(s)}},Quit:function(){v(),s.oncontextmenu=null,s["on"+e[0]]=null,t||document.removeEventListener(e[1],d)},UpdateClone:p}})(),c=(()=>{let s=null,a=null,l=[],h=null,c=null,u=!0;const d=e=>{if(l.length>0){let i=t?e.touches[0].pageX:e.x,r=t?e.touches[0].pageY:e.y,o=n({canvas:s,event:{x:i,y:r}}),a=l[l.length-1];a.x=o.x,a.y=o.y,g()}e.preventDefault()},g=()=>{let{strokeWidth:t,strokeColor:e}=h.strokeConfig,{width:n,height:s}=h.canvas,o=l[0],u=l[1];a.clearRect(0,0,n,s),a.drawImage(c,0,0),o&&(u?i({ctx:a,start:o,end:u,strokeWidth:t,strokeColor:e}):r({ctx:a,type:"circle",fillStyle:"#000000",param:{x:o.x,y:o.y,radiusX:1,radiusY:1}}))},v=()=>{l.length=0,g()},p=()=>{c=o(h.canvas)};return{name:"line",Start:function(){c=o(this.canvas),l=[],h=this,s=this.canvas,a=this.ctx;const i=t=>{t.preventDefault()},r=()=>{2===l.length&&(u=!0,l.length=0,this.OperatingEnd(),p()),document.removeEventListener("selectstart",i),document.removeEventListener(e[2],r),document.removeEventListener(e[1],d)};s["on"+e[0]]=o=>{if(!t&&1!==o.buttons)return;let a=t?o.touches[0].pageX:o.x,h=t?o.touches[0].pageY:o.y,c=n({canvas:s,event:{x:a,y:h}});u&&(this.OperatingStart(),u=!1),l.push(c),g(),document.addEventListener(e[1],d,{passive:!1}),document.addEventListener("selectstart",i),document.addEventListener(e[2],r)},s.oncontextmenu=t=>{t.preventDefault(),v(),this.OperatingEnd(),c=o(s)}},Quit:function(){v(),s.oncontextmenu=null,s["on"+e[0]]=null,t||document.removeEventListener(e[1],d)},UpdateClone:p}})(),u=(()=>{let s=null,o=null;return{Start:function(){let a=null;s=this.canvas,o=this.ctx;const l=t=>{t.preventDefault()},h=e=>{let{clearRadius:l,clearColor:h}=this,c=t?e.touches[0].pageX:e.x,u=t?e.touches[0].pageY:e.y,d=n({canvas:s,event:{x:c,y:u}});this.Operating(),a?i({start:a,end:d,ctx:o,strokeWidth:2*l,strokeColor:h}):r({ctx:o,type:"circle",fillStyle:h,param:{x:d.x,y:d.y,radiusX:l,radiusY:l}}),a=d,e.preventDefault()},c=()=>{a=null,this.OperatingEnd(),document.removeEventListener(e[1],h),document.removeEventListener("selectstart",l),document.removeEventListener(e[2],c)};s["on"+e[0]]=i=>{let{clearRadius:a,clearColor:u}=this,d=t?i.touches[0].pageX:i.x,g=t?i.touches[0].pageY:i.y,v=n({canvas:s,event:{x:d,y:g}});this.OperatingStart(),r({ctx:o,type:"circle",fillStyle:u,param:{x:v.x,y:v.y,radiusX:a,radiusY:a}}),document.addEventListener(e[1],h,{passive:!1}),document.addEventListener("selectstart",l),document.addEventListener(e[2],c)}},Quit:function(){s["on"+e[0]]=null}}})(),d=(()=>{let s=null,r=null,a=[],l=null,h=null,c=!0;const u=e=>{if(a.length>0){let i=t?e.touches[0].pageX:e.x,r=t?e.touches[0].pageY:e.y,o=n({canvas:s,event:{x:i,y:r}}),l=a[a.length-1];l.x=o.x,l.y=o.y,d()}},d=()=>{let{strokeWidth:t,strokeColor:e}=l.strokeConfig,{width:n,height:s}=l.canvas;r.clearRect(0,0,n,s),r.drawImage(h,0,0);for(let n=0;n<a.length;n++){let s=null,o=a[n];s=0===a.length?o:0===n?a[a.length-1]:a[n-1],i({ctx:r,start:s,end:o,strokeWidth:t,strokeColor:e})}},g=()=>{t||a.length>0&&(a.length-=1),a.length<3&&(a.length=0),d(),a.length=0};return{name:"polygon",Start:function(){h=o(this.canvas),a=[],l=this,s=this.canvas,r=this.ctx;const i=t=>{t.preventDefault()},v=()=>{if(0!==a.length){if(!t){let{x:t,y:e}=a[a.length-1];a.push({x:t,y:e})}a.length>3&&this.OperatingEnd(),d(),document.removeEventListener("selectstart",i),document.removeEventListener(e[2],v)}};s["on"+e[0]]=r=>{if(!t&&1!==r.buttons)return;let o=t?r.touches[0].pageX:r.x,l=t?r.touches[0].pageY:r.y,h=n({canvas:s,event:{x:o,y:l}});(t||0===a.length)&&a.push({...h}),c&&(this.OperatingStart(),c=!1),document.addEventListener("selectstart",i),document.addEventListener(e[2],v)},s.oncontextmenu=t=>{t.preventDefault(),g(),this.OperatingEnd(),h=o(s)},t||document.addEventListener(e[1],u)},Quit:function(){g(),s.oncontextmenu=null,s["on"+e[0]]=null,t||document.removeEventListener(e[1],u)},UpdateClone:()=>{h=o(l.canvas)}}})();let g=!1,v=!1;const p=(t,e)=>{var n=0;return Object.keys(t).map((i=>{n+=(t[i]-e[i])**2})),Math.sqrt(n)},y=t=>{let{imageData:e,coord:n}=t,{x:i,y:s}=n,{width:r,height:o,data:a}=e;var l=s*(4*r)+4*i;return{r:a[l],g:a[l+1],b:a[l+2],a:a[l+3]}};function f(t,e,n){return(e=function(t){var e=function(t){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var n=e.call(t,"string");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(t)}(t);return"symbol"==typeof e?e:e+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}const x={pen:s,rline:l,hline:h,line:c,eraser:u,polygon:d,paintBucket:(()=>{let i=null,s=null,r=!1;return{Start:function(){i=this.canvas,s=this.ctx,i["on"+e[0]]=e=>{if(r)return void console.log("bucket doing");let{strokeColor:o}=this.strokeConfig,a=t?e.touches[0].pageX:e.x,l=t?e.touches[0].pageY:e.y,h=n({canvas:i,event:{x:a,y:l}});this.OperatingStart(),(t=>{let{ctx:e,currCoord:n,inputColor:i,cb:s}=t,r=Math.round(n.x),o=Math.round(n.y),{width:a,height:l}=e.canvas,h=e.getImageData(0,0,a,l),c=y({coord:{x:r,y:o},imageData:h}),u={},d=[[r,o]],f=!1,x=null;if(v)console.warn("task running.");else if(v=!0,g=!1,i=(t=>{let e;if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(t))return e=t.substring(1).split(""),3===e.length&&(e=[e[0],e[0],e[1],e[1],e[2],e[2]]),e="0x"+e.join(""),{r:e>>16&255,g:e>>8&255,b:255&e,a:255};throw new Error("Bad Hex")})(i),0!==p(i,c))try{!function t(){let n=d;if(f=!1,x=500,d=[],g)throw v=!1,new Error("User interrupt");for(let t of n){let[e,n]=t;m(e,n)}f?setTimeout((function(){t()}),0):(v=!1,e.putImageData(h,0,0),s&&s("done"))}()}catch(t){s&&s(t)}else s&&s("same color");function m(t,e){if(g)return;if(u[t+"_"+e]&&u[t+"_"+e]++,x--<0)return f=!0,void d.push([t,e]);let n=y({coord:{x:t,y:e},imageData:h});if(p(c,n)<10){(t=>{let{imageData:e,coord:n,rgba:i}=t,{x:s,y:r}=n,{width:o,height:a,data:l}=e;var h=r*(4*o)+4*s;let{r:c,g:u,b:d,a:g}=i;g=g||255,l[h]=c,l[h+1]=u,l[h+2]=d,l[h+3]=g})({imageData:h,rgba:i,coord:{x:t,y:e}}),u[t+"_"+e]=!0;for(let n=t-1;n<t+2;n++)for(let t=e-1;t<e+2;t++)0<=n&&n<a&&0<=t&&t<l&&!u[n+"_"+t]&&(u[n+"_"+t]=!0,m(n,t))}}})({inputColor:o,currCoord:h,ctx:s,cb:t=>{r=!1,this.OperatingEnd()}})}},Quit:function(){g=!0,i["on"+e[0]]=null}}})()};window.PaintBoard=class{constructor(t){let{canvas:e,strokeConfig:n={},clearColor:i="#ffffff",clearRadius:s=16,enableHistory:r=!1,historyMax:o=10,historyInterval:a=500,background:l,...h}=t;f(this,"lastOperatingEnd",null),f(this,"isContinuous",null),f(this,"currentTool",null),f(this,"strokeConfig",{strokeWidth:1,strokeColor:"#000000"}),this.props=h;let c=this.props;if(c.logicalWidth=Math.round(c.logicalWidth),c.logicalHeight=Math.round(c.logicalHeight),e.width=c.logicalWidth,e.height=c.logicalHeight,Object.assign(this.strokeConfig,n),l){let{image:t,color:n}=l;e.style.background="".concat(n||""," url(").concat(t.src,") 0 0 no-repeat"),e.style.backgroundSize="contain",e.style.backgroundSize="100% 100%"}this.background=l,this.clearColor=i,this.historyInterval=a,this.clearRadius=s,this.canvas=e,this.ctx=e.getContext("2d"),r&&(this.enableHistory=r,this.historyMax=o,this.historyIndex=-1,this.historyStack=[]),this.Clear()}Tool(t){const e=x[t];this.currentTool?(this.currentTool.Quit(),this.currentTool===e?this.currentTool=null:(this.currentTool=e,e.Start.apply(this))):(this.currentTool=e,e.Start.apply(this))}Method(t){this.currentTool&&this.currentTool.Quit(),this[t=t.substr(0,1).toUpperCase()+t.substr(1,t.length)](),this.currentTool&&"polygon"===this.currentTool.name&&this.currentTool.UpdateClone(),this.currentTool&&this.currentTool.Start.apply(this)}OperatingStart(){this.enableHistory&&(this.isClean=!1,this.ClearRedoList(),this.isContinuous=Date.now()-this.lastOperatingEnd<this.historyInterval)}Operating(){}OperatingEnd(){this.lastOperatingEnd=Date.now(),this.enableHistory&&(this.Snapshot(this.isContinuous),this.lastOperatingEnd=Date.now())}Clear(){if(this.CleanBoard(),this.enableHistory){this.ClearRedoList();let t=this.historyStack[this.historyIndex];if(t&&"clear"===t.t)return;this.historyIndex+=1,this.Snapshot()}}CleanBoard(){this.ctx.save(),"transparent"===this.clearColor?(this.ctx.fillStyle="#ffffff",this.ctx.globalCompositeOperation="destination-out"):this.ctx.fillStyle=this.clearColor,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore()}ClearRedoList(){this.historyStack.length=this.historyIndex+1}ApplyHistory(){let t=this.historyStack[this.historyIndex];if(t)if("init"===t.t||"clear"===t.t)this.CleanBoard(),this.isClean=!0;else{let e=new ImageData(t.data,this.canvas.width,this.canvas.height);this.ctx.putImageData(e,0,0)}}Undo(){this.enableHistory&&0!==this.historyStack.length&&(this.historyIndex-=1,this.historyIndex<0&&(this.historyIndex=0),this.ApplyHistory())}Redo(){this.enableHistory&&0!==this.historyStack.length&&(this.historyIndex+=1,this.historyIndex>this.historyStack.length-1?this.historyIndex=this.historyStack.length-1:this.ApplyHistory())}Snapshot(){let t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],e=null;e=this.isClean?{t:"clear"}:{time:Date.now(),data:this.canvas.getContext("2d").getImageData(0,0,this.canvas.width,this.canvas.height).data},t&&this.historyStack.pop(),this.historyStack.length>=this.historyMax&&this.historyStack.shift(),this.historyStack.push(e),this.historyIndex=this.historyStack.length-1}SaveData(t){let e,{returnType:n="arraybuffer",compBg:i=!1,cb:s}=t,{logicalWidth:r,logicalHeight:o}=this.props;if(i){let t,{image:n}=this.background;e=document.createElement("canvas"),e.width=r,e.height=o,t=e.getContext("2d"),t.drawImage(n,0,0,r,o),t.drawImage(this.canvas,0,0,r,o)}else e=this.canvas;if("file"===n)e.toBlob((t=>{let e=new File([t],"user-board.png",{lastModified:new Date});s(e)}),"image/png");else{if("arraybuffer"===n)return this.ctx.getImageData(0,0,r,o).data.buffer;if("base64"===n)return e.toDataURL("image/png")}}}})();